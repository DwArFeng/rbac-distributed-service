# Pexp V2 - 权限表达式 V2 说明文档

## 说明

V2 权限表达式，是一种在 `1.8.0.a` 版本后提供的权限表达式，具备更强大的功能。

V2 权限表达式支持多逻辑权限匹配功能，允许您在同一权限表达式中使用管道符进行多个权限过滤器的组合。

## 语法

V2 权限表达式的构成为：

```
v2;<修饰符><权限过滤器类型>@<权限过滤器匹配模式>[|<权限过滤器类型>@<权限过滤器匹配模式>...]
```

其精确的语法如下：

```
[v2;]<+|-|!><type>@<pattern>[\|<type>@<pattern>...]
```

在其中：

`[v2;]` 是版本标识符，为固定值。

`<+|-|!>` 是权限修饰符：

- `+` 是接受修饰符，如果权限通过测试，则权限的接受程度为 `ACCEPT`。
- `-` 是排除修饰符，如果权限通过测试，则权限的接受程度为 `REJECT`。
- `!` 是全局排除修饰符，如果权限通过测试，则权限的接受程度为 `GLOBAL_REJECT`。

`type` 是权限过滤器，有关权限表达式的说明，请参阅文档中对应的章节。 此版本的权限过滤器中如果包含 `@` 或 `|`，则需要转义。

`pattern` 是权限过滤器匹配模式，匹配模式的语法由权限过滤器类型决定。
您可以参考对应的权限过滤器的文档来了解匹配模式的语法，也可以在项目启动后重置权限过滤器支持，
并在数据库中的权限过滤器支持表 `tbl_permission_filter_support` 中查看对应的权限过滤器的 `example_pattern` 列。
此版本的权限过滤器匹配模式如果包含 `@` 或 `|`，则需要转义。

`[\|<type>@<pattern>...]` 是可选的部分，表示多个权限过滤器的组合。
需要注意的是，本文档中精确语法部分由于需要与 `|` 符号进行区分，因此在此处使用了 `\|` 进行转义，
您在实际使用时不需要转义，请直接使用 `|` 符号。

## 管道符

管道符 `|` 用于连接多个权限过滤器，表示这些权限过滤器之间是逻辑与的关系。

对于一个管道中的所有权限过滤器组成的列表，在权限判断时，从第一个到最后一个依次进行判断，只要有任意一个权限过滤器不通过，
则整个管道不通过，其权限接受程度为 `NOT_ACCEPT`。

您可以使用管道符快速达成绝大部分常用的权限过滤器组合逻辑，如属于 `foobar` 权限组，且权限等级小于等于 `100` 的所有权限。

## 示例

以下是一些 V2 权限表达式的示例（包含不合法的示例，请注意区分）：

| 序号 | 表达式                             | 是否合法 | 描述                        |
|:---|:--------------------------------|:-----|:--------------------------|
| 1  | v2;+foo@bar                     | 合法   | 合法表达式，不包含管道。              |
| 2  | v2;-foo@bar                     | 合法   | 合法表达式，不包含管道。              |
| 3  | v2;!foo@bar                     | 合法   | 合法表达式，不包含管道。              |
| 4  | v2;+foo@bar\|baz@qux            | 合法   | 合法表达式，包含管道。               |
| 5  | v2;+foo@bar\|baz@qux            | 合法   | 合法表达式，包含管道。               |
| 6  | v2;+foo@bar\|baz@qux\|quux@bax  | 合法   | 合法表达式，包含管道。               |
| 7  | v2;                             | 不合法  | 不合法表达式，空字符串。              |
| 8  | v2;foo@bar                      | 不合法  | 不合法表达式，缺少修饰符。             |
| 9  | v2;foo@bar\|baz@qux             | 不合法  | 不合法表达式，包含管道，缺少修饰符。        |
| 10 | v2;+@bar                        | 不合法  | 不合法表达式，缺少过滤器类型。           |
| 11 | v2;+foo@bar\|@qux               | 不合法  | 不合法表达式，包含管道，缺少过滤器类型。      |
| 12 | v2;+foo@bar\|                   | 不合法  | 不合法表达式，管道符后没有内容。          |
| 13 | v2;\|foo@bar                    | 不合法  | 不合法表达式，管道符前没有内容。          |
| 14 | v2;+foo@bar\\\|bar\|baz@qux     | 合法   | 合法表达式，包含管道符转义。            |
| 15 | v2;+foo@bar\\\\\|bar@\|baz@qux  | 合法   | 合法表达式，包含转义符转义。            |
| 16 | v2;+foo@bar\\                   | 不合法  | 不合法表达式，非法转义。              |
| 17 | v2;+foo@bar\\b                  | 不合法  | 不合法表达式，非法转义。              |
| 18 | v2;+foo@bar\|baz@qux\\          | 不合法  | 不合法表达式，包含管道，非法转义。         |
| 19 | v2;+foo@bar\|baz@qux\\q         | 不合法  | 不合法表达式，包含管道，非法转义。         |
| 20 | v2;+bar                         | 不合法  | 不合法表达式，缺少匹配模式分隔符。         |
| 21 | v2;+bar\\@bar                   | 不合法  | 不合法表达式，缺少匹配模式分隔符。         |
| 22 | v2;+foo@bar\|baz                | 不合法  | 不合法表达式，包含管道，缺少匹配模式分隔符。    |
| 23 | v2;+foo@bar\|baz\\@baz          | 不合法  | 不合法表达式，包含管道，缺少匹配模式分隔符。    |
| 24 | v2;+                            | 不合法  | 不合法表达式，修饰符提前结束。           |
| 25 | v2;-                            | 不合法  | 不合法表达式，修饰符提前结束。           |
| 26 | v2;!                            | 不合法  | 不合法表达式，修饰符提前结束。           |
| 27 | v2;-foo\\\\foo@bar\|baz\\\\@baz | 合法   | 合法表达式，包含管道，转义符转义。         |
| 28 | v2;-foo\\\|foo@bar\|baz\\\|@baz | 合法   | 合法表达式，包含管道，管道符转义。         |
| 29 | v2;-foo\\                       | 不合法  | 不合法表达式，转义符提前结束。           |
| 30 | v2;-foo\\foo@bar                | 不合法  | 不合法表达式，非法转义符。             |
| 31 | v2;+foo@bar\|baz\\baz@qux       | 不合法  | 不合法表达式，包含管道，非法转义符。        |
| 32 | v2;+foo\|foo@bar                | 不合法  | 不合法表达式，单独出现的管道符。          |
| 33 | v2;+foo@bar\|baz\|baz@qux       | 不合法  | 不合法表达式，包含管道，单独出现的管道符。     |
| 34 | v2;+foo@bar@bar                 | 不合法  | 不合法表达式，单独出现的匹配模式分隔符。      |
| 35 | v2;+foo@bar\|baz@qux@qux        | 不合法  | 不合法表达式，包含管道，单独出现的匹配模式分隔符。 |
| 36 | v2;+foo@bar\\@bar               | 合法   | 合法表达式，匹配模式分隔符转义。          |
| 37 | v2;+foo@bar\|baz@qux\\@qux      | 合法   | 合法表达式，包含管道，匹配模式分隔符转义。     |

## 建议

我们强烈建议您使用普通的字符（如小写字符与`-`, `_`, `.` 等分隔符）作为权限过滤器类型，
并且避免使用权限表达式种潜在的控制符与关键字。这样做会提高权限表达式的可维护性，也能使权限表达式更高概率成功解析。
